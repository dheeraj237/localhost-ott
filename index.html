<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
		integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
		integrity="sha512-..." crossorigin="anonymous" />

	<title>Movie Streaming</title>
	<style>
		.artplayer-app {
			width: 100%;
			height: auto;
		}
	</style>
</head>

<body>
	<nav class="navbar navbar-expand-lg navbar-light bg-light">
		<a class="navbar-brand" href="#">Movie Streaming
			<span id="servingFrom" class="ml-1 text-muted">
			</span>
		</a>
	</nav>
	<hr />
	<div class="col-12">
		<ul id="movieList" class="list-group"></ul>
	</div>
	<hr />
	<div class="row m-3">
		<div class="col">
			<p class="text-muted">
				Movies: <span id="movieCount"></span> |
				Folders: <span id="folderCount"></span> |
				Current directory: <span id="currentDir"></span>
			</p>
		</div>
	</div>
	<div class="modal fade" id="playerModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-body p-0">
					<div class="artplayer-app"></div>
				</div>
			</div>
		</div>
	</div>
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
		integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
		integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
		integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
		crossorigin="anonymous"></script>
	<script src="https://unpkg.com/artplayer/dist/artplayer.js"></script>
	<!-- <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script> -->

	<script>
		var art = new Artplayer({
			container: ".artplayer-app",
			theme: "#ffad00",
			autoplay: true,
			setting: true,
			pip: true,
			autoSize: true,
			aspectRatio: true,
			fullscreen: true,
			airplay: true,
			hotkey: true,
			fastForward: true,
			lock: true,
			volume: 0.9,
		});

		async function renderTable(dir) {
			const path = dir || "";
			// fetch movies from /movies endpoint
			const response = await fetch(`/movies?dir=${dir}`);
			const allItems = await response.json();

			// Clear existing content
			document.getElementById("movieList").innerHTML = "";

			// // Render directory list
			if (dir !== "") {
				const backDir = document.createElement("li");
				backDir.classList.add("list-group-item");
				backDir.innerHTML = '<i class="fas fa-arrow-left"></i> Back';
				backDir.addEventListener("click", () => {
					renderTable(getParentDir(dir));
				});
				document.getElementById("movieList").appendChild(backDir);
			}

			// Render directory list
			allItems.directories.forEach((directory) => {
				const listItem = document.createElement("li");
				listItem.classList.add("list-group-item");
				listItem.innerHTML =
					'<i class="fas fa-folder mr-2"></i>&nbsp;' + directory;
				listItem.addEventListener("click", () => {
					renderTable(directory);
				});
				document.getElementById("movieList").appendChild(listItem);
			});

			// Render file list
			allItems.files.forEach((file) => {
				const listItem = document.createElement("li");
				listItem.classList.add("list-group-item", "cursor-pointer");
				listItem.innerHTML = `
						<div class="d-flex justify-content-between">
							<div class="d-flex align-items-center">
								<i class="fas fa-file-video mr-2"></i>
								<span style="word-wrap: break-word;">${sanitizeFileName(file.filename)}</span>
							</div>
							</div>
							</div>
							</div>
						</div>
						<div class="text-muted mt-1">
							<span>${file.size}</span>
							<span class="ml-2">${file.createdTime}</span>
						</div>
					`;
				listItem.addEventListener("click", () => {
					loadPlayer(file.path);
					$("#playerModal").modal("show", (event) => {
						console.log("modal opened");
					});
				});
				document.getElementById("movieList").appendChild(listItem);
			});
			document.getElementById("movieCount").textContent = allItems.totalFiles;
			document.getElementById("folderCount").textContent = allItems.totalDirectories;
			document.getElementById("currentDir").textContent = allItems.directoryPath;
			document.getElementById("servingFrom").textContent = `(${allItems.servingFrom})`;
		}

		function loadPlayer(link) {
			console.log("clicked link", link);
			if (art && link) {
				art.url = link;
				// check if link.srt file exist
				subLink = link.replace(/\.[^/.]+$/, ".srt");
				console.log("subLink", subLink);
				art.subtitle = {
					url: subLink,
					type: "srt",
					encoding: "utf-8",
					escape: true,
					style: {
						color: "#03A9F4",
						"font-size": "30px",
					},
				};
			}
		}

		function getParentDir(dir) {
			const lastIndex = dir.lastIndexOf("/");
			if (lastIndex !== -1) {
				return dir.substring(0, lastIndex);
			} else {
				return "";
			}
		}

		// remove any special charector like . and _ from file name with space
		function sanitizeFileName(fileName) {
			return fileName.replace(/[_\.-]/g, " ");
		}

		document.addEventListener("DOMContentLoaded", function () {
			renderTable("");
		});

		$("#playerModal").on("hidden.bs.modal", function (e) {
			if (art) {
				art.pause();
			}
		});
		$("#playerModal").on("shown.bs.modal", function () {
			if (art) {
				let playerElement = art?.video;
				// get videoHieght and videoWidth and set to div with class artplayer-app
				let videoHeight = playerElement?.videoHeight;
				let videoWidth = playerElement?.videoWidth;
				const aspectRatio = videoWidth / videoHeight;
				const artplayerApp = document.querySelector(".artplayer-app");
				const containerWidth = artplayerApp.offsetWidth;
				const containerHeight = containerWidth / aspectRatio;
				// console.log("videoHeight", videoHeight, "videoWidth", videoWidth);
				// console.log("containerWidth", containerWidth, "containerHeight", containerHeight);
				artplayerApp.style.width = `${containerWidth}px`;
				artplayerApp.style.height = `${containerHeight}px`;
			}
		});
	</script>
</body>

</html>